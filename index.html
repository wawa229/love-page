<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Particle Text Effect</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
    }
    #matrix {
      z-index: 0; /* Matrix canvas ·ªü d∆∞·ªõi */
    }
    #sketch-container canvas {
      z-index: 1; /* Particle canvas ·ªü tr√™n */
    }
  </style>
</head>
<body>
  <!-- Matrix Background Canvas -->
  <canvas id="matrix"></canvas>

  <!-- Main Canvas for Particles -->
  <div id="sketch-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/p5.min.js"></script>
  <script>
    // Matrix background effect
    const matrixCanvas = document.getElementById("matrix");
    const matrixCtx = matrixCanvas.getContext("2d");
    matrixCanvas.width = window.innerWidth;
    matrixCanvas.height = window.innerHeight;

    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    const matrixFontSize = 16;
    const columns = Math.floor(matrixCanvas.width / matrixFontSize);
    const drops = Array(columns).fill(1);

    function drawMatrix() {
      matrixCtx.fillStyle = "rgba(0, 0, 0, 0.05)";
      matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
      matrixCtx.font = matrixFontSize + "px monospace";
      matrixCtx.fillStyle = "#B10DC9";

      for (let i = 0; i < drops.length; i++) {
        const text = letters[Math.floor(Math.random() * letters.length)];
        matrixCtx.fillText(text, i * matrixFontSize, drops[i] * matrixFontSize);
        if (drops[i] * matrixFontSize > matrixCanvas.height && Math.random() > 0.975) {
          drops[i] = 0;
        }
        drops[i]++;
      }
    }
    setInterval(drawMatrix, 33);

    // Particle text effect
    let font;
    let particles = [];
    let currentText = 0;
    const texts = ["3", "2", "1", "Happy Birthday", "27.06.2001", "Linh Anh", "üíñ Good things will come üíñ"];
    let pg;

    function preload() {
      // S·ª≠ d·ª•ng font m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng t·∫£i ƒë∆∞·ª£c
      font = loadFont(
        'https://cdnjs.cloudflare.com/ajax/libs/topcoat/0.8.0/font/SourceCodePro-Regular.otf',
        () => console.log("Font loaded successfully"),
        () => console.error("Font load failed, using default font")
      );
    }

    function setup() {
      console.log("Setup called");
      const canvas = createCanvas(window.innerWidth, window.innerHeight);
      canvas.parent('sketch-container');
      frameRate(60);

      // T·∫°o offscreen buffer
      pg = createGraphics(width, height);
      pg.textAlign(CENTER, CENTER);
      pg.textFont(font || 'Arial'); // S·ª≠ d·ª•ng Arial n·∫øu font kh√¥ng t·∫£i ƒë∆∞·ª£c

      showText(texts[currentText]);

      // ƒê·ªïi vƒÉn b·∫£n m·ªói 5 gi√¢y
      setInterval(() => {
        currentText = (currentText + 1) % texts.length;
        showText(texts[currentText]);
      }, 5000);
    }

    function showText(txt) {
      console.log("Showing text:", txt);
      particles = [];

      // ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc font
      const fontSize = ["3", "2", "1"].includes(txt) ? 300 : 120;

      // V·∫Ω vƒÉn b·∫£n l√™n offscreen buffer
      pg.clear();
      pg.background(0, 0, 0, 0); // Trong su·ªët
      pg.fill(255);
      pg.textSize(fontSize);
      pg.text(txt, width / 2, height / 2);

      // T·∫£i d·ªØ li·ªáu pixel
      pg.loadPixels();
      console.log("Pixel data length:", pg.pixels.length);

      // T·∫°o particles t·ª´ pixel c·ªßa vƒÉn b·∫£n
      const step = 4; // B∆∞·ªõc l·ªõn h∆°n ƒë·ªÉ gi·∫£m s·ªë l∆∞·ª£ng particles
      const bounds = font ? font.textBounds(txt, 0, 0, fontSize) : { w: 300, h: 100 };
      const xStart = width / 2 - bounds.w / 2;
      const yStart = height / 2 + bounds.h / 2;

      for (let y = yStart - bounds.h; y < yStart; y += step) {
        for (let x = xStart; x < xStart + bounds.w; x += step) {
          const index = (Math.floor(x) + Math.floor(y) * width) * 4;
          if (x >= 0 && x < width && y >= 0 && y < height && pg.pixels[index] > 50) {
            console.log("Creating particle at", x, y);
            for (let i = 0; i < 2; i++) {
              particles.push(new Particle(
                x + random(-50, 50), // V·ªã tr√≠ ban ƒë·∫ßu g·∫ßn h∆°n
                y + random(-50, 50),
                x + random(-1, 1),
                y + random(-1, 1)
              ));
            }
          }
        }
      }
      console.log("Total particles:", particles.length);
    }

    function draw() {
      clear();
      for (let p of particles) {
        p.update();
        p.display();
      }
    }

    class Particle {
      constructor(x, y, tx, ty) {
        this.pos = createVector(x, y);
        this.target = createVector(tx, ty);
        this.vel = createVector();
        this.acc = createVector();
        this.maxSpeed = 8; // TƒÉng t·ªëc ƒë·ªô
        this.maxForce = 0.5; // TƒÉng l·ª±c
        this.size = 2.5;
      }

      update() {
        const desired = p5.Vector.sub(this.target, this.pos);
        const d = desired.mag();
        let speed = this.maxSpeed;
        if (d < 100) speed = map(d, 0, 100, 0, this.maxSpeed);

        desired.setMag(speed);
        const steer = p5.Vector.sub(desired, this.vel);
        steer.limit(this.maxForce);
        this.acc.add(steer);

        this.vel.add(this.acc);
        this.pos.add(this.vel);
        this.acc.mult(0);
      }

      display() {
        stroke(0, 255, 255); // Cyan
        strokeWeight(this.size);
        point(this.pos.x, this.pos.y);
      }
    }

    // X·ª≠ l√Ω resize
    window.addEventListener('resize', function() {
      matrixCanvas.width = window.innerWidth;
      matrixCanvas.height = window.innerHeight;
      resizeCanvas(window.innerWidth, window.innerHeight);
      pg = createGraphics(window.innerWidth, window.innerHeight); // C·∫≠p nh·∫≠t pg
      pg.textAlign(CENTER, CENTER);
      pg.textFont(font || 'Arial');
      showText(texts[currentText]); // C·∫≠p nh·∫≠t particles
    });
  </script>
</body>
</html>
